var json;var ipJson;const net=require("net");var mysql=require("mysql");var maxmind=require("maxmind");var Config=require("config-js");var config=new Config("application/config/config.js");var dbcon=mysql.createPool({connectionLimit:config.get("sequel.conlimt"),host:config.get("sequel.link"),user:config.get("sequel.juzer"),password:config.get("sequel.lozinka"),database:config.get("sequel.baza"),port:config.get("sequel.prt")});var cityLookup=maxmind.openSync("data/maxmind/GeoLite2-City.mmdb");var processor=net.createServer(function(a){if(a.address().address!="127.0.0.1"){console.error(new Date(),"Address is not localhost!!! You are invaded!!!",a.address().address);console.error("Processor: Performing immediate security shutdown.");a.end()}a.on("end",function(){console.log(new Date(),"Processor: Server disconnected");a.end()});a.on("data",function(b){var e=JSON.parse(b);console.log(new Date(),"DATA: should be json: %s",e);switch(e.data){case"newconn":NewConnection(b,function(f){a.write(f)});break;case"eventWord":InsertEventWord(b,function(f){a.write(f)});break;case"personWord":InsertPersonWord(b,function(f){a.write(f)});break;case"newPersonPageLoaded":var d=[];function c(f,h){var g={};g[f]=h;d.push(g)}PersonPageLoaded(b,function(f){PersonCntPageLoaded(b,function(g){c("global",f);c("continent",g);a.write(JSON.stringify(d))})});break;case"newEventPageLoaded":var d=[];function c(f,h){var g={};g[f]=h;d.push(g)}EventPageLoaded(b,function(f){console.log("DATA: newEventPageLoaded: end of EventPageLoaded - result: ",f);EventCntPageLoaded(b,function(g){console.log("DATA: newEventPageLoaded: end of EventCntPageLoaded - result: ",g);c("global",f);c("continent",g);a.write(JSON.stringify(d))})});break;default:}})});processor.listen(3001,"localhost",function(){testDataBaseConnection();console.log(config.get("ver.proc"),"Processor is listening and Database is online!")});function NewConnection(c,e){var b={};var d=require("moment");var a=d().format("YYYYWW");c=JSON.parse(c);console.log(new Date(),"NEWCONNECTION: Incomming message from server.js: %s",c.visitor.address);b=c.visitor;if((b.address!=="::1")&&(b.address!=="::ffff:127.0.0.1")&&(b.address!=="fe80::1")){ipJson=cityLookup.get(b.address);console.log("Real World IP address: ",b.address)}else{b.address="::ffff:24.201.206.226";ipJson=cityLookup.get(b.address);console.log(new Date(),"Failed IP address lookup. Using fake - ::ffff:24.201.206.226")}dbcon.getConnection(function(g,f){f.query(config.get("prsn.cur"),a,function(h,i){if(h){if(h.fatal){throw h}console.error("Processor: NewConnection: Event: ",new Date(),config.get("poruke.konNaBazu"),h.code,h.fatal)}f.query(config.get("evnt.cur"),a,function(k,j){if(k){if(k.fatal){throw k}console.error("Processor: NewConnection: Event: ",new Date(),config.get("poruke.konNaBazu"),k.code,k.fatal)}f.query(config.get("ewrd.lst"),j[0].event_id,function(l,m){if(l){if(l.fatal){throw l}console.error("Processor: NewConnection: Event: ",new Date(),config.get("poruke.konNaBazu"),l.code,l.fatal)}f.query(config.get("pwrd.lst"),i[0].person_id,function(n,o){if(n){if(n.fatal){throw n}console.error("Processor: NewConnection: Person: ",new Date(),config.get("poruke.konNaBazu"),n.code,n.fatal)}f.query(config.get("vstr.ins"),[b.address,null,null],function(r,q){if(r){if(r.fatal){throw r}console.error("Processor: NewConnection: Visitor: ",new Date(),config.get("poruke.konNaBazu"),r.code,r.fatal)}b.id=q.insertId;if(!ipJson.city){f.query(config.get("lctn.ins2"),[ipJson.country.names.en,ipJson.continent.names.en,b.id],function(s,t){if(s){if(s.fatal){throw s}console.error("Processor: List: Insert location without city: ",new Date(),config.get("poruke.upitNijeOK"),s.code,s.fatal)}b.location=t.insertId})}else{f.query(config.get("lctn.ins1"),[ipJson.city.names.en,ipJson.country.names.en,ipJson.continent.names.en,b.id],function(s,t){if(s){if(s.fatal){throw s}console.error("Processor: List: Insert location with city: ",new Date(),config.get("poruke.upitNijeOK"),s.code,s.fatal)}b.location=t.insertId})}var p=JSON.stringify({eventList:m,personList:o,visitorid:q.insertId,event:j,person:i,week:a});e(p)})})})});f.release()})})}function InsertEventWord(a,b){a=JSON.parse(a);console.log("DATA: EventWord: Incoming message from server.js: %s",a.data,a.word,a.event_id,a.visitor);dbcon.getConnection(function(e,c){var d;c.query(config.get("ewrd.ins"),[a.word,a.visitor.id,a.event_id],function(f,g){if(f){if(f.fatal){throw f}console.error("Processor: Insert: EventWord: ",new Date(),config.get("poruke.upitNijeOK"),f.code,f.fatal)}d=g.insertId;c.query(config.get("ewrd.lst"),a.event_id,function(h,i){if(h){if(h.fatal){throw h}console.error("Processor: List: EventWord: ",new Date(),config.get("poruke.konNaBazu"),h.code,h.fatal)}ritrn=JSON.stringify(i);b(ritrn)});c.release()})})}function InsertPersonWord(a,b){a=JSON.parse(a);console.log("DATA: PersonWord: Incoming message from client: %s",JSON.stringify(a));dbcon.getConnection(function(d,c){var e;c.query(config.get("pwrd.ins"),[a.word,a.visitor.id,a.person_id],function(f,g){if(f){if(f.fatal){throw f}console.error("Processor: Insert: PersonWord: tpword ",new Date(),config.get("poruke.upitNijeOK"),f.code,f.fatal)}e=g.insertId;c.query(config.get("pwrd.lst"),a.person_id,function(h,i){if(h){if(h.fatal){throw h}console.error("Processor: List: PersonWord: ",new Date(),config.get("poruke.konNaBazu"),h.code,h.fatal)}ritrn=JSON.stringify(i);b(ritrn)});c.release()})})}function EventPageLoaded(a,b){a=JSON.parse(a);console.log("DATA: EventPageLoaded: Response from client: %s",a.data,a.event_id);dbcon.getConnection(function(d,c){c.query(config.get("ewrd.flst"),a.event_id,function(e,f){if(e){if(e.fatal){throw e}console.error("Processor: List: EventWord: ",new Date(),config.get("poruke.konNaBazu"),e.code,e.fatal)}ritrn=JSON.stringify(f);b(ritrn)});c.release()})}function EventCntPageLoaded(a,b){a=JSON.parse(a);continents=[];results=[];console.log("DATA: EventPageLoaded: Response from client: %s",a.data);dbcon.getConnection(function(d,c){c.query(config.get("lctn.cnt"),function(f,g){if(f){if(f.fatal){throw f}console.error("Processor: EventCntPageLoaded: ContinentList",new Date(),config.get("poruke.konNaBazu"),f.code,f.fatal)}continents=g;var e=0;continents.forEach(function(i,k,h){e++;var j=[];c.query(config.get("ewrd.lstpcnt"),[i.continent,a.event_id],function(l,m){if(l){if(l.fatal){throw l}console.error("Processor: EventCntPageLoaded: ContinentList",new Date(),config.get("poruke.konNaBazu"),l.code,l.fatal)}j={cont:i.continent,ewords:m};results.push(j);if(k===h.length-1){ritrn=JSON.stringify(results);console.log("ritrn: ",ritrn);b(ritrn)}})})});c.release()})}function PersonPageLoaded(a,b){a=JSON.parse(a);console.log("DATA: PersonPageLoaded: Response from client: %s",a.data,a.person_id);dbcon.getConnection(function(d,c){c.query(config.get("pwrd.flst"),a.person_id,function(e,f){if(e){if(e.fatal){throw e}console.error("Processor: List: PersonWord: ",new Date(),config.get("poruke.konNaBazu"),e.code,e.fatal)}ritrn=JSON.stringify(f);b(ritrn)});c.release()})}function PersonCntPageLoaded(a,b){a=JSON.parse(a);continents=[];results=[];console.log("DATA: PersonCntPageLoaded: Response from client: %s",a.data);dbcon.getConnection(function(d,c){c.query(config.get("lctn.cnt"),function(f,g){if(f){if(f.fatal){throw f}console.error("Processor: PersonCntPageLoaded: ContinentList",new Date(),config.get("poruke.konNaBazu"),f.code,f.fatal)}continents=g;var e=0;continents.forEach(function(i,k,h){e++;var j=[];c.query(config.get("pwrd.lstpcnt"),[i.continent,a.person_id],function(l,m){if(l){if(l.fatal){throw l}console.error("Processor: PersonCntPageLoaded: ContinentList",new Date(),config.get("poruke.konNaBazu"),l.code,l.fatal)}j={cont:i.continent,pwords:m};results.push(j);if(k===h.length-1){ritrn=JSON.stringify(results);b(ritrn)}})})});c.release()})}function testDataBaseConnection(){dbcon.query("SELECT 1+0 AS selection",function(a,b){if(a){if(a.fatal){console.log("Processor: ",new Date(),"Doslo je do prekida komunikacije sa bazom podataka");throw a}console.error("Processor: ",new Date(),"Could not connect to the db. Check if the DB is running?",a.code,a.fatal)}else{console.log("Processor: ",new Date(),"Connection successful",b[0].selection);console.log("Processor: Database is set.")}})};