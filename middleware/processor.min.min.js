var json;var ipJson;const net=require("net");var mysql=require("mysql");var maxmind=require("maxmind");var Config=require("config-js");var config=new Config("application/config/config.js");var dotenv=require("dotenv");var error=dotenv.config({path:__dirname});if(error){throw error}var dbcon=mysql.createPool({connectionLimit:config.get("sequel.conlimt"),host:config.get("sequel.link"),user:config.get("sequel.juzer"),password:config.get("sequel.lozinka"),database:config.get("sequel.baza"),port:config.get("sequel.prt")});var cityLookup=maxmind.openSync("data/maxmind/GeoLite2-City.mmdb");var processor=net.createServer(function(b){if(b.address().address!="127.0.0.1"){console.error(new Date(),"Address is not localhost!!! You are invaded!!!",b.address().address);console.error("Processor: Performing immediate security shutdown.");b.end()}b.on("end",function(){console.log(new Date(),"Processor: Server disconnected");b.end()});b.on("data",function(a){var f=JSON.parse(a);console.log(new Date(),"DATA: should be json: %s",f);switch(f.data){case"newconn":NewConnection(a,function(c){b.write(c)});break;case"eventWord":InsertEventWord(a,function(c){b.write(c)});break;case"personWord":InsertPersonWord(a,function(c){b.write(c)});break;case"newPersonPageLoaded":var g=[];function h(e,c){var d={};d[e]=c;g.push(d)}PersonPageLoaded(a,function(c){PersonCntPageLoaded(a,function(d){h("global",c);h("continent",d);b.write(JSON.stringify(g))})});break;case"person":CheckEventID(a,function(c){console.log("rezultat: ",c);b.write(c)});break;case"event":CheckEventID(a,function(c){console.log("rezultat: ",c);b.write(c)});break;case"newEventPageLoaded":var g=[];function h(e,c){var d={};d[e]=c;g.push(d)}EventPageLoaded(a,function(c){console.log("DATA: newEventPageLoaded: end of EventPageLoaded - result: ",c);EventCntPageLoaded(a,function(d){console.log("DATA: newEventPageLoaded: end of EventCntPageLoaded - result: ",d);h("global",c);h("continent",d);b.write(JSON.stringify(g))})});break;default:}})});processor.listen(3001,"localhost",function(){testDataBaseConnection();console.log(config.get("ver.proc"),"Processor is listening and Database is online!")});function NewConnection(j,h){var f={};var i=require("moment");var g=i().format("YYYYWW");j=JSON.parse(j);console.log(new Date(),"NEWCONNECTION: Incomming message from server.js: %s",j.visitor.address);f=j.visitor;if((f.address!=="::1")&&(f.address!=="::ffff:127.0.0.1")&&(f.address!=="fe80::1")){ipJson=cityLookup.get(f.address);console.log("pronadjena adresa izgleda ovako: ",ipJson.country.names.en)}else{f.address="::ffff:24.201.206.226";ipJson=cityLookup.get(f.address);console.log(new Date(),"Failed IP address lookup. Using fake ::ffff:24.201.206.226: ",f.address)}dbcon.getConnection(function(a,b){b.query(config.get("prsn.cur"),g,function(d,c){if(d){if(d.fatal){throw d}console.error("Processor: NewConnection: Event: ",new Date(),config.get("poruke.konNaBazu"),d.code,d.fatal)}b.query(config.get("evnt.cur"),g,function(e,l){if(e){if(e.fatal){throw e}console.error("Processor: NewConnection: Event: ",new Date(),config.get("poruke.konNaBazu"),e.code,e.fatal)}b.query(config.get("ewrd.lst"),l[0].event_id,function(n,k){if(n){if(n.fatal){throw n}console.error("Processor: NewConnection: Event: ",new Date(),config.get("poruke.konNaBazu"),n.code,n.fatal)}b.query(config.get("pwrd.lst"),c[0].person_id,function(p,m){if(p){if(p.fatal){throw p}console.error("Processor: NewConnection: Person: ",new Date(),config.get("poruke.konNaBazu"),p.code,p.fatal)}b.query(config.get("vstr.ins"),[f.address,null,null],function(o,s){if(o){if(o.fatal){throw o}console.error("Processor: NewConnection: Visitor: ",new Date(),config.get("poruke.konNaBazu"),o.code,o.fatal)}f.id=s.insertId;if(!ipJson.city){b.query(config.get("lctn.ins2"),[ipJson.country.names.en,ipJson.continent.names.en,f.id],function(r,q){if(r){if(r.fatal){throw r}console.error("Processor: List: Insert location without city: ",new Date(),config.get("poruke.upitNijeOK"),r.code,r.fatal)}f.location=q.insertId})}else{b.query(config.get("lctn.ins1"),[ipJson.city.names.en,ipJson.country.names.en,ipJson.continent.names.en,f.id],function(r,q){if(r){if(r.fatal){throw r}console.error("Processor: List: Insert location with city: ",new Date(),config.get("poruke.upitNijeOK"),r.code,r.fatal)}f.location=q.insertId})}var t=JSON.stringify({eventList:k,personList:m,visitorid:s.insertId,event:l,person:c,week:g});h(t)})})})});b.release()})})}function InsertEventWord(d,c){d=JSON.parse(d);console.log("DATA: EventWord: Incoming message from server.js: %s",d.data,d.word,d.event_id,d.visitor);dbcon.getConnection(function(a,f){var b;f.query(config.get("ewrd.ins"),[d.word,d.visitor.id,d.event_id],function(h,e){if(h){if(h.fatal){throw h}console.error("Processor: Insert: EventWord: ",new Date(),config.get("poruke.upitNijeOK"),h.code,h.fatal)}b=e.insertId;f.query(config.get("ewrd.lst"),d.event_id,function(j,g){if(j){if(j.fatal){throw j}console.error("Processor: List: EventWord: ",new Date(),config.get("poruke.konNaBazu"),j.code,j.fatal)}ritrn=JSON.stringify(g);c(ritrn)});f.release()})})}function InsertPersonWord(d,c){d=JSON.parse(d);console.log("DATA: PersonWord: Incoming message from client: %s",JSON.stringify(d));dbcon.getConnection(function(b,f){var a;f.query(config.get("pwrd.ins"),[d.word,d.visitor.id,d.person_id],function(h,e){if(h){if(h.fatal){throw h}console.error("Processor: Insert: PersonWord: tpword ",new Date(),config.get("poruke.upitNijeOK"),h.code,h.fatal)}a=e.insertId;f.query(config.get("pwrd.lst"),d.person_id,function(j,g){if(j){if(j.fatal){throw j}console.error("Processor: List: PersonWord: ",new Date(),config.get("poruke.konNaBazu"),j.code,j.fatal)}ritrn=JSON.stringify(g);c(ritrn)});f.release()})})}function CheckEventID(d,f){d=JSON.parse(d);console.log("DATA: CheckEventID: Response from client: %s",d.data,d.week);var e;if(d.data=="event"){e=config.get("evnt.cur")}else{e=config.get("prsn.cur")}console.log("DATA: CheckEventID: Query looks like: %s",e);dbcon.getConnection(function(a,b){console.log("initializing connection to the database: ",e);b.query(e,d.week,function(h,c){if(h){if(h.fatal){throw h}console.error("Processor: List: CheckEventID: ",new Date(),config.get("poruke.konNaBazu"),h.code,h.fatal)}ritrn=JSON.stringify(c);console.log("CheckEventID: ",ritrn);f(ritrn)});b.release()})}function EventPageLoaded(d,c){d=JSON.parse(d);console.log("DATA: EventPageLoaded: Response from client: %s",d.data,d.event_id);dbcon.getConnection(function(a,b){b.query(config.get("ewrd.flst"),d.event_id,function(h,g){if(h){if(h.fatal){throw h}console.error("Processor: List: EventWord: ",new Date(),config.get("poruke.konNaBazu"),h.code,h.fatal)}ritrn=JSON.stringify(g);c(ritrn)});b.release()})}function EventCntPageLoaded(d,c){d=JSON.parse(d);continents=[];results=[];console.log("DATA: EventPageLoaded: Response from client: %s",d.data);dbcon.getConnection(function(a,b){b.query(config.get("lctn.cnt"),function(i,h){if(i){if(i.fatal){throw i}console.error("Processor: EventCntPageLoaded: ContinentList",new Date(),config.get("poruke.konNaBazu"),i.code,i.fatal)}continents=h;var j=0;continents.forEach(function(g,e,l){j++;var f=[];b.query(config.get("ewrd.lstpcnt"),[g.continent,d.event_id],function(n,k){if(n){if(n.fatal){throw n}console.error("Processor: EventCntPageLoaded: ContinentList",new Date(),config.get("poruke.konNaBazu"),n.code,n.fatal)}f={cont:g.continent,ewords:k};results.push(f);if(e===l.length-1){ritrn=JSON.stringify(results);console.log("ritrn: ",ritrn);c(ritrn)}})})});b.release()})}function PersonPageLoaded(d,c){d=JSON.parse(d);console.log("DATA: PersonPageLoaded: Response from client: %s",d.data,d.person_id);dbcon.getConnection(function(a,b){b.query(config.get("pwrd.flst"),d.person_id,function(h,g){if(h){if(h.fatal){throw h}console.error("Processor: List: PersonWord: ",new Date(),config.get("poruke.konNaBazu"),h.code,h.fatal)}ritrn=JSON.stringify(g);c(ritrn)});b.release()})}function PersonCntPageLoaded(d,c){d=JSON.parse(d);continents=[];results=[];console.log("DATA: PersonCntPageLoaded: Response from client: %s",d.data);dbcon.getConnection(function(a,b){b.query(config.get("lctn.cnt"),function(i,h){if(i){if(i.fatal){throw i}console.error("Processor: PersonCntPageLoaded: ContinentList",new Date(),config.get("poruke.konNaBazu"),i.code,i.fatal)}continents=h;var j=0;continents.forEach(function(g,e,l){j++;var f=[];b.query(config.get("pwrd.lstpcnt"),[g.continent,d.person_id],function(n,k){if(n){if(n.fatal){throw n}console.error("Processor: PersonCntPageLoaded: ContinentList",new Date(),config.get("poruke.konNaBazu"),n.code,n.fatal)}f={cont:g.continent,pwords:k};results.push(f);if(e===l.length-1){ritrn=JSON.stringify(results);c(ritrn)}})})});b.release()})}function testDataBaseConnection(){dbcon.query("SELECT 1+0 AS selection",function(d,c){if(d){if(d.fatal){console.log("Processor: ",new Date(),"Doslo je do prekida komunikacije sa bazom podataka");throw d}console.error("Processor: ",new Date(),"Could not connect to the db. Check if the DB is running?",d.code,d.fatal)}else{console.log("Processor: ",new Date(),"Connection successful",c[0].selection);console.log("Processor: Database is set.")}})};