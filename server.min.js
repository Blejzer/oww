var ver="owwServer v.0.1-alpha.20f";var express=require("express");var app=express();var http=require("http").Server(app);var io=require("socket.io")(http);const fs=require("fs");var eventList;var personList;const net=require("net");var bodyParser=require("body-parser");console.log(new Date());console.log(ver,"starting with initialization sequence: ");console.log("Loaded all required modules");app.enable("trust proxy");app.use("/bootstrap",express["static"]("bootstrap"));app.use("/scripts",express["static"]("node_modules/"));app.use("/custom",express["static"]("custom"));app.use("/images",express["static"]("images"));app.use("/application",express["static"]("application"));app.use("/views",express["static"]("views"));app.use("/.well-known",express["static"]("/.well-known"));app.set("view engine","ejs");console.log("All static routes are set");console.log("*********************************************************************\n");app.get("/sociale",function(i,g){var h=i.headers["user-agent"];console.log("This is SOCIALE req.url: ",i.url);var e=i.headers["x-forwarded-for"]||i.connection.remoteAddress;console.log(new Date(),"Client IP Address - assuming remote: socket.handshake.address: ",e);const c=[/facebookexternalhit\/[0-9]/,/Faceboot/];const b=c.some(function(j){return j.test(h)});console.log("User-Agent: "+h);console.log("isMatch: ",b);if(!b){console.log("FB visitor: Redirecting...");g.redirect("/")}else{console.log("serving fb boot");var f={};f.address=e;var d={data:"newconn",visitor:f};jack=JSON.stringify(d);var a=new net.Socket();a.on("error",function(j){console.error(new Date(),"Error connecting to the processor. shutting down the server...",j);a.end();process.exit(0)});a.connect(3001,"localhost",function(){console.log(new Date(),"Server: Connected to processor");a.write(jack)});a.on("data",function(k){var j=JSON.parse(k);j.num=io.engine.clientsCount;console.log(new Date(),"Server: Response from the processor: %s",j.event[0]);g.render("social/event.ejs",{event:j.event[0]},function(m,l){g.send(l)});f.id=j.visitorid;a.end()})}});app.get("/socialp",function(i,g){var h=i.headers["user-agent"];console.log("This is SOCIALP req.url: ",i.url);var e=i.headers["x-forwarded-for"]||i.connection.remoteAddress;console.log(new Date(),"Client IP Address - assuming remote: socket.handshake.address: ",e);const c=[/facebookexternalhit\/[0-9]/,/Faceboot/];const b=c.some(function(j){return j.test(h)});console.log("User-Agent: "+h);console.log("isMatch: ",b);if(!b){console.log("FB visitor: Redirecting...");g.redirect("/")}else{console.log("serving fb boot");var f={};f.address=e;var d={data:"newconn",visitor:f};jack=JSON.stringify(d);var a=new net.Socket();a.on("error",function(j){console.error(new Date(),"Error connecting to the processor. shutting down the server...",j);a.end();process.exit(0)});a.connect(3001,"localhost",function(){console.log(new Date(),"Server: Connected to processor");a.write(jack)});a.on("data",function(k){var j=JSON.parse(k);j.num=io.engine.clientsCount;console.log(new Date(),"Server: Response from the processor: %s",j.person[0]);g.render("social/person.ejs",{event:j.person[0]});f.id=j.visitorid;a.end()})}});app.get("/home",function(b,a){var g=b.headers["user-agent"];console.log("This is HOME req.url: ",b.url);var f=b.headers["x-forwarded-for"]||b.connection.remoteAddress;console.log(new Date(),"Client IP Address - assuming remote: socket.handshake.address: ",f);var d={};d.address=f;var c={data:"newconn",visitor:d};jack=JSON.stringify(c);var e=new net.Socket();e.on("error",function(h){console.error(new Date(),"Error connecting to the processor. shutting down the server...",h);e.end();process.exit(0)});e.connect(3001,"localhost",function(){console.log(new Date(),"Server: Connected to processor");e.write(jack)});e.on("data",function(i){var h=JSON.parse(i);h.num=io.engine.clientsCount;console.log(new Date(),"Server: Response from the processor: %s",h.event[0]);a.send(h);d.id=h.visitorid;e.end()})});app.get("*",function(c,a){var e=c.headers["user-agent"];console.log("This is * req.url: ",c.url);const d=[/person/,/event/];const b=d.some(function(f){return f.test(c.url)});console.log("isMatch: ",b);if(b){a.redirect("/")}else{a.sendFile(__dirname+"/views/index.html")}});console.log("index.html page prepped to be served");console.log("*********************************************************************\n");console.log("*********************************************************************\n");console.log("I guess we're all set.");console.log("*********************************************************************\n");console.log(ver," is online and ready!");console.log("*********************************************************************\n");io.sockets.on("connection",function(a){a.removeAllListeners();var e=a.handshake.address;console.log(new Date(),"Client IP Address - assuming remote: socket.handshake.address: ",e);var c={};c.address=e;var b={data:"newconn",visitor:c};jack=JSON.stringify(b);var d=new net.Socket();d.on("error",function(f){console.error(new Date(),"Error connecting to the processor. shutting down the server...",f);d.end();process.exit(0)});d.connect(3001,"localhost",function(){d.write(jack)});d.on("data",function(g){var f=JSON.parse(g);a.emit("test",f.event[0],f.person[0]);c.id=f.visitorid;io.sockets.emit("conn",io.engine.clientsCount);io.emit("eventList",JSON.stringify(f.eventList));io.emit("personList",JSON.stringify(f.personList));d.end()});a.on("disconnect",function(){console.log(new Date(),"Diskonekcija: Broj trenutnih korisnika: ",io.engine.clientsCount);io.sockets.emit("conn",io.engine.clientsCount);a.removeAllListeners();a.leaveAll()});a.on("event",function(j,h,g){console.log(new Date(),"Registrujem event socket ",g);var f={data:"eventWord",visitor:c,word:h,event_id:g};jack=JSON.stringify(f);var i=new net.Socket();i.connect(3001,"localhost",function(){console.log(new Date(),"Server: eword: Connected to processor",jack);i.write(jack)});io.emit("eventWord",h);i.on("data",function(l){var k=JSON.parse(l);console.log("data: ",k);io.emit("eventList",JSON.stringify(k));i.end()})});a.on("person",function(j,f,g){var h={data:"personWord",visitor:c,word:f,person_id:g};jack=JSON.stringify(h);var i=new net.Socket();i.connect(3001,"localhost",function(){console.log("Server: pword: Connected to processor",jack);i.write(jack)});io.emit("personWord",f);i.on("data",function(l){var k=JSON.parse(l);io.emit("personList",JSON.stringify(k));i.end()})});a.on("newPersonPageLoaded",function(f){console.log("Registrujem personPageLoaded socket ",f);var g={data:"newPersonPageLoaded",person_id:f};jack=JSON.stringify(g);var h=new net.Socket();h.connect(3001,"localhost",function(){console.log("Server: newPersonPageLoaded: Connected to Processor");h.write(jack)});h.on("data",function(j){var i=JSON.parse(j);var i=JSON.parse(j);console.log("list",i);console.log("list[0]",i[0]);console.log("test",i[0].global);console.log("list[1]",i[1].continent);a.emit("personCtnPageSuccess",i[1].continent);a.emit("personPageSuccess",i[0].global);h.end()})});a.on("newEventPageLoaded",function(g){console.log("Registrujem newEventPageLoaded socket ",g);var f={data:"newEventPageLoaded",event_id:g};jack=JSON.stringify(f);var h=new net.Socket();h.connect(3001,"localhost",function(){console.log("Server: newEventPageLoaded: Connected to Processor");h.write(jack)});h.on("data",function(j){var i=JSON.parse(j);console.log("list",i);console.log("list[0]",i[0]);console.log("test",i[0].global);console.log("list[1]",i[1].continent);a.emit("eventCtnPageSuccess",i[1].continent);a.emit("eventPageSuccess",i[0].global);h.end()})})});http.listen(80,function(){console.log(ver," Initialization sequence complete. ");console.log(new Date(),"Started listening on port:80")});