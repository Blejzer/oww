var express=require("express");var cookieParser=require("cookie-parser");var session=require("express-session");var bodyParser=require("body-parser");var flash=require("connect-flash");var morgan=require("morgan");var passport=require("passport");var fs=require("fs");var app=express();var http=require("http").Server(app);var path=require("path");var multer=require("multer");var name;var dotenv=require("dotenv");var port=8089;var uploadFileName="";const myError=dotenv.config({path:"/Volumes/Projects/Internal/onewordworld/.env"});if(myError.error){throw myError.error}console.log("process.env",process.env);var db=require(process.env.OWW_DEV_PATH+"/romanija/config/processing");console.log("baza podataka: ",db.constructor);var privateKey=fs.readFileSync(process.env.OWW_DEV_PATH+"/romanija/localhost-key.pem","utf8");var certificate=fs.readFileSync(process.env.OWW_DEV_PATH+"/romanija/localhost-cert.pem","utf8");var options={key:privateKey,cert:certificate,requestCert:false,rejectUnauthorized:false,passphrase:"Id10ti"};var storage=multer.diskStorage({destination:function(c,b,a){console.log("setting up destination");a(null,process.env.OWW_DEV_PATH+"/images/upload")},filename:function(d,b,a){console.log("setting up filename");var c=Date.now();name=b.fieldname+"-"+c+"."+b.originalname.split(".")[b.originalname.split(".").length-1];uploadFileName=name;a(null,name)}});console.log("File upload destination set to: "+process.env.OWW_DEV_PATH+"/images/upload");console.log("*********************************************************************\n");var upload=multer({storage:storage}).single("file");require(process.env.OWW_DEV_PATH+"/romanija/config/passport")(passport);app.use("/joli",express["static"](process.env.OWW_DEV_PATH+"/romanija/joli"));app.use("/scripts",express["static"](process.env.OWW_DEV_PATH+"/node_modules"));app.use("/client",express["static"](process.env.OWW_DEV_PATH+"/romanija/client"));app.use("/images",express["static"](process.env.OWW_DEV_PATH+"/images"));app.set("views",path.join(process.env.OWW_DEV_PATH,"/romanija/views"));app.set("view engine","ejs");app.set("view options",{layout:false});app.set("trust proxy",1);app.use(flash());app.use(morgan("dev"));app.use(cookieParser());app.use(bodyParser.urlencoded({extended:true}));app.use(bodyParser.json());app.use(checkAuth);app.use(session({secret:"vidyapathaisalwaysrunning",resave:true,saveUninitialized:true}));app.use(passport.initialize());app.use(passport.session());app.post("/event",isLoggedIn,function(b,a){upload(b,a,function(c){if(c){a.json({error_code:1,err_desc:"TEST: "+c});return}var e=a.req.file.path.substring(process.env.OWW_DEV_PATH.length+1);var d={title:a.req.body.title,path:e,week:a.req.body.week};db.insertEvent(d,function(f){console.log("DATA: end of InsertEventWord - result: ",f);if(f.weekcheck){a.json({error_code:0,err_desc:"Event successfully created"})}else{a.json({error_code:1,err_desc:"Event for this week already created. Please check the date!"})}})})});app.post("/person",isLoggedIn,function(b,a){upload(b,a,function(c){if(c){a.json({error_code:1,err_desc:c});return}console.log(a.req.body.title);console.log(a.req.file.path);console.log(a.req.body.week);var e=a.req.file.path.substring(process.env.OWW_DEV_PATH.length+1);var d={title:a.req.body.title,path:e,week:a.req.body.week};db.insertPerson(d,function(f){console.log("DATA: end of InsertPerson - result: ",f);if(f.weekcheck){a.json({error_code:0,err_desc:"Person successfully created"})}else{a.json({error_code:1,err_desc:"Person for this week already created. Please check the date!"})}})})});app.get("/main",isLoggedIn,function(d,b,c){console.log("Request Type:",d.method);var a=[];var e=[];db.mainLists(function(f){a=f.eventList;e=f.personList;console.log("test: ",e);return b.render("main.ejs",{user:d.user,eventList:a,personList:e})})});app.use(function(c,a,b){a.setHeader("Access-Control-Allow-Methods","POST, PUT, OPTIONS, DELETE, GET");a.header("Access-Control-Allow-Origin","https://localhost");a.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept");b()});function isLoggedIn(c,a,b){if(c.isAuthenticated()){return b()}a.redirect("/")}console.log("multer settings set!");console.log("*********************************************************************\n");require(process.env.OWW_DEV_PATH+"/romanija/app/routes.js")(app,passport);function checkAuth(c,a,b){console.log("checkAuth "+c.url);if(c.url==="/secure"&&(!c.session||!c.session.authenticated)){a.render("unauthorised",{status:403});return}b()}http.listen(port,function(){console.log(" Initialization sequence complete. ");console.log(new Date(),"Started Secure TLS listening on port:8089")});